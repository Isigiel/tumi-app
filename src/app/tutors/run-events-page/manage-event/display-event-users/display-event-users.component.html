<!--
  ~     The TUMi app provides a modern way of managing events for an esn section.
  ~     Copyright (C) 2020  Lukas Heddendorp
  ~
  ~     This program is free software: you can redistribute it and/or modify
  ~     it under the terms of the GNU General Public License as published by
  ~     the Free Software Foundation, either version 3 of the License, or
  ~     (at your option) any later version.
  ~
  ~     This program is distributed in the hope that it will be useful,
  ~     but WITHOUT ANY WARRANTY; without even the implied warranty of
  ~     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  ~     GNU General Public License for more details.
  ~
  ~     You should have received a copy of the GNU General Public License
  ~     along with this program.  If not, see <https://www.gnu.org/licenses/>.
  -->

<h2 class="mat-display-4 no-margin">Users related to this event</h2>
<a href="mailto:{{ tutorEmail }}" mat-flat-button target="_blank">Send Mail to Tutors</a>
<pre class="selectable">{{ tutorEmail }}</pre>
<table [dataSource]="event.tutorUsers" [trackBy]="trackById" mat-table style="width: 100%;">
  <ng-container matColumnDef="name">
    <th *matHeaderCellDef mat-header-cell>Name</th>
    <td *matCellDef="let element" mat-cell>{{ element?.firstName }} {{ element?.lastName }}</td>
  </ng-container>
  <ng-container matColumnDef="mail">
    <th *matHeaderCellDef mat-header-cell>Mail</th>
    <td *matCellDef="let element" mat-cell>{{ element?.email }}</td>
  </ng-container>
  <ng-container matColumnDef="action">
    <th *matHeaderCellDef mat-header-cell>Remove</th>
    <td *matCellDef="let element" mat-cell>
      <button (click)="kickTutor(element)" *ngIf="isAdmin$ | async" mat-button>
        Remove from Event
      </button>
    </td>
  </ng-container>
  <tr *matHeaderRowDef="['name', 'mail', 'action']" mat-header-row></tr>
  <tr *matRowDef="let row; columns: ['name', 'mail', 'action']" mat-row></tr>
</table>

<p style="margin-top: 2rem;"><strong>Students registered for this event</strong>&nbsp;({{ event.coming.length }})</p>
<a
  href="mailto:tumi-koordination@zv.tum.de?subject={{ encodedEventName }}&cc={{ tutorEmail }}&bcc={{
    participantEmail
  }}"
  mat-flat-button
  target="_blank"
  >Send Mail to Participants</a
>
<pre class="selectable">{{ participantEmail }}</pre>
<table [dataSource]="event.coming" [trackBy]="trackById" mat-table style="width: 100%;">
  <ng-container matColumnDef="info">
    <th *matHeaderCellDef mat-header-cell>Info</th>
    <td *matCellDef="let element" mat-cell>
      <ng-container *ngIf="!!element.user; else userLoading">
        {{ element.user?.firstName }} {{ element.user?.lastName }}
        <span *ngIf="!element.user?.firstName && !element.user?.lastName">({{ element.user?.email }})</span>
      </ng-container>
    </td>
  </ng-container>
  <ng-container matColumnDef="phone">
    <th *matHeaderCellDef mat-header-cell>Phone</th>
    <td *matCellDef="let element" mat-cell>
      {{ element.user?.phone }}
    </td>
  </ng-container>
  <ng-container matColumnDef="actions">
    <th *matHeaderCellDef mat-header-cell>Actions</th>
    <td *matCellDef="let element" mat-cell>
      <button (click)="collectPayment(element.user)" *ngIf="!element.hasPayed && event.hasFee" mat-flat-button>
        Confirm Payment
      </button>
      <button
        (click)="makeTransaction(element.user)"
        *ngIf="(isAdmin$ | async) && event.id === 'aMGWtSFlbzFKJfUsY9z8'"
        mat-flat-button
      >
        Add transaction for this user
      </button>
      <button (click)="removeUser(element.user)" *ngIf="isAdmin$ | async" mat-button>
        Remove from Event
      </button>
      <button (click)="registerUser(element.user)" *ngIf="!element.hasAttended" mat-button>
        Confirm Attendance
      </button>
      <button (click)="deregisterUser(element.user)" *ngIf="element.hasAttended" color="warn" mat-flat-button>
        Cancel Attendance
      </button>
    </td>
  </ng-container>
  <tr *matHeaderRowDef="columns$ | async" mat-header-row></tr>
  <tr *matRowDef="let row; columns: columns$ | async" mat-row></tr>
</table>

<p style="margin-top: 2rem;">
  <strong>Hygiene table</strong> (click table to select and then copy it to your document)
</p>
<div class="selectable hygene-table">
  <table>
    <thead>
      <tr>
        <td>Event Name:</td>
        <td colspan="4">{{ event.name }}</td>
      </tr>
      <tr>
        <td>Date:</td>
        <td colspan="4">{{ event.start | date: 'mediumDate' }}</td>
      </tr>
      <tr>
        <td>Tutors:</td>
        <td colspan="4">
          <ng-container *ngFor="let tutor of event.tutorUsers"
            >{{ tutor?.firstName }} {{ tutor?.lastName }},
          </ng-container>
        </td>
      </tr>
      <tr>
        <td colspan="5">Participants (including tutors):</td>
      </tr>
      <tr class="centered">
        <th>Name</th>
        <th>Address</th>
        <th>Phone Number</th>
        <th>E-mail</th>
        <th>Signature</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let user of event.tutorUsers">
        <td>{{ user?.firstName }} {{ user?.lastName }}</td>
        <td>{{ user?.address }}</td>
        <td>{{ user?.phone }}</td>
        <td>{{ user?.email }}</td>
        <td>&nbsp;</td>
      </tr>
      <tr *ngFor="let registration of event.coming">
        <td>{{ registration.user?.firstName }} {{ registration.user?.lastName }}</td>
        <td>{{ registration.user?.address }}</td>
        <td>{{ registration.user?.phone }}</td>
        <td>{{ registration.user?.email }}</td>
        <td>&nbsp;</td>
      </tr>
    </tbody>
  </table>
</div>

<p style="margin-top: 2rem;"><strong>Students on the waiting list</strong>&nbsp;({{ event.waitlist.length }})</p>
<table [dataSource]="event.waitlist" [trackBy]="trackById" mat-table style="width: 100%;">
  <ng-container matColumnDef="name">
    <th *matHeaderCellDef mat-header-cell>Name</th>
    <td *matCellDef="let element" mat-cell>{{ element.user?.firstName }} {{ element.user?.lastName }}</td>
  </ng-container>
  <ng-container matColumnDef="timestamp">
    <th *matHeaderCellDef mat-header-cell>Timestamp</th>
    <td *matCellDef="let element" mat-cell>{{ element.timestamp | date: 'medium' }}</td>
  </ng-container>
  <ng-container matColumnDef="mail">
    <th *matHeaderCellDef mat-header-cell>Mail</th>
    <td *matCellDef="let element" mat-cell>{{ element.user?.email }}</td>
  </ng-container>
  <ng-container matColumnDef="actions">
    <th *matHeaderCellDef mat-header-cell></th>
    <td *matCellDef="let element" mat-cell>
      <button (click)="bumpUser(element.user)" *ngIf="isAdmin$ | async" mat-button>
        Bump up from wait list
      </button>
    </td>
  </ng-container>
  <tr *matHeaderRowDef="['name', 'timestamp', 'mail', 'actions']" mat-header-row></tr>
  <tr *matRowDef="let row; columns: ['name', 'timestamp', 'mail', 'actions']" mat-row></tr>
</table>

<ng-template #userLoading>
  User is loading
</ng-template>
